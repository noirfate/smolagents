"""
漏洞原因分析器 - 第二阶段
负责深入分析漏洞的技术原理、代码层面的问题和修复方案
"""

import os
from smolagents import (
    DuckDuckGoSearchTool,
    CodeAgent,
    GitHubTools,
)

try:
    from scripts.text_web_browser import (
        ArchiveSearchTool,
        FinderTool,
        FindNextTool,
        PageDownTool,
        PageUpTool,
        SimpleTextBrowser,
        VisitTool,
    )
    from scripts.text_inspector_tool import TextInspectorTool
except ImportError:
    print("⚠️ 高级浏览器工具未找到，使用基础搜索功能")
    ArchiveSearchTool = None
    SimpleTextBrowser = None


class VulnerabilityAnalyzer:
    """漏洞原因分析器"""
    
    def __init__(self, model, max_steps=30):
        self.model = model
        self.max_steps = max_steps
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """创建专门用于漏洞技术分析的agent"""
        
        # 基础工具
        tools = [DuckDuckGoSearchTool()]
        
        # 尝试添加高级浏览器工具
        if SimpleTextBrowser and ArchiveSearchTool:
            try:
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
                browser_config = {
                    "viewport_size": 1024 * 5,
                    "downloads_folder": "downloads",
                    "request_kwargs": {
                        "headers": {"User-Agent": user_agent},
                        "timeout": 300,
                    },
                    "serpapi_key": os.getenv("SERPAPI_API_KEY"),
                    "use_browser_for_text": True,
                }
                
                os.makedirs("./downloads", exist_ok=True)
                browser = SimpleTextBrowser(**browser_config)
                
                tools.extend([
                    VisitTool(browser),
                    PageUpTool(browser),
                    PageDownTool(browser),
                    FinderTool(browser),
                    FindNextTool(browser),
                    ArchiveSearchTool(browser),
                ])
                
                if TextInspectorTool:
                    tools.append(TextInspectorTool(self.model, 100000))
                    
            except Exception as e:
                print(f"⚠️ 高级浏览器工具初始化失败: {e}")
        
        # 尝试添加GitHub工具
        try:
            github_token = os.getenv("GITHUB_TOKEN")
            if github_token:
                github_tools = GitHubTools(github_token)
                tools.extend(github_tools.tools)
        except Exception as e:
            print(f"⚠️ GitHub工具初始化失败: {e}")
        
        agent = CodeAgent(
            model=self.model,
            tools=tools,
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=2,
            planning_interval=4,
            name="vulnerability_analyzer",
            description="""漏洞分析专家，具备深厚的安全技术功底，能够理解复杂的技术细节,专门负责漏洞的技术分析, 能够深入分析漏洞的技术原理，包括但不限于：
            
            1. 漏洞的根本原因和触发机制
            2. 代码层面的缺陷分析
            3. 攻击向量和利用条件
            4. 缓解措施分析
            5. 修复代码分析
            6. 相关漏洞的对比研究
            """,
        )
        
        return agent
    
    def run(self, task):
        """执行漏洞技术分析任务"""
        print(f"🔬 开始分析漏洞技术原理...")
        
        enhanced_task = f"""
{task}

---

注意事项：
1. 在对漏洞做技术原理分析时，不要对产生漏洞的相关代码片段以及补丁修复代码片段做精简，要如实输出
2. 在对漏洞做技术原理分析时，不要采用总结的表述方式，要对其进行深入细致的分析并详细输出分析过程

请按照以下markdown结构输出技术分析结果：

## 漏洞分析
根据搜集到的信息，总结漏洞的成因及技术原理
### 技术原理
根据漏洞产生的代码，分析漏洞的具体技术原理，需要附带漏洞相关的代码块，如果有补丁或修复代码，则需要对修复代码进行分析，检查修复是否完善
### 排查指导
根据漏洞产生的原理，给出排查指导，要列出具体的排查步骤，需要包含多种排查方法，如：
1. 根据漏洞组件版本进行排查
2. 根据触发漏洞的现象进行排查，构造简单的检测脚本
### 缓解措施
根据漏洞的成因及技术原理，给出缓解措施，需要列出具体的缓解措施执行步骤
### 参考链接
给出获得上述事实的参考链接
1. 
2. 
...
n. 

"""
        
        result = self.agent.run(enhanced_task)
        return result
