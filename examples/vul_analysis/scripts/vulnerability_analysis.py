"""
æ¼æ´åŸå› åˆ†æå™¨ - ç¬¬äºŒé˜¶æ®µ
è´Ÿè´£æ·±å…¥åˆ†ææ¼æ´çš„æŠ€æœ¯åŸç†ã€ä»£ç å±‚é¢çš„é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ
"""

import os
from smolagents import (
    DuckDuckGoSearchTool,
    CodeAgent,
    GitHubTools,
)

try:
    from scripts.text_web_browser import (
        ArchiveSearchTool,
        FinderTool,
        FindNextTool,
        PageDownTool,
        PageUpTool,
        SimpleTextBrowser,
        VisitTool,
    )
    from scripts.text_inspector_tool import TextInspectorTool
except ImportError:
    print("âš ï¸ é«˜çº§æµè§ˆå™¨å·¥å…·æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºç¡€æœç´¢åŠŸèƒ½")
    ArchiveSearchTool = None
    SimpleTextBrowser = None


class VulnerabilityAnalyzer:
    """æ¼æ´åŸå› åˆ†æå™¨"""
    
    def __init__(self, model, max_steps=30):
        self.model = model
        self.max_steps = max_steps
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """åˆ›å»ºä¸“é—¨ç”¨äºæ¼æ´æŠ€æœ¯åˆ†æçš„agent"""
        
        # åŸºç¡€å·¥å…·
        tools = [DuckDuckGoSearchTool()]
        
        # å°è¯•æ·»åŠ é«˜çº§æµè§ˆå™¨å·¥å…·
        if SimpleTextBrowser and ArchiveSearchTool:
            try:
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
                browser_config = {
                    "viewport_size": 1024 * 5,
                    "downloads_folder": "downloads",
                    "request_kwargs": {
                        "headers": {"User-Agent": user_agent},
                        "timeout": 300,
                    },
                    "serpapi_key": os.getenv("SERPAPI_API_KEY"),
                    "use_browser_for_text": True,
                }
                
                os.makedirs("./downloads", exist_ok=True)
                browser = SimpleTextBrowser(**browser_config)
                
                tools.extend([
                    VisitTool(browser),
                    PageUpTool(browser),
                    PageDownTool(browser),
                    FinderTool(browser),
                    FindNextTool(browser),
                    ArchiveSearchTool(browser),
                ])
                
                if TextInspectorTool:
                    tools.append(TextInspectorTool(self.model, 100000))
                    
            except Exception as e:
                print(f"âš ï¸ é«˜çº§æµè§ˆå™¨å·¥å…·åˆå§‹åŒ–å¤±è´¥: {e}")
        
        # å°è¯•æ·»åŠ GitHubå·¥å…·
        try:
            github_token = os.getenv("GITHUB_TOKEN")
            if github_token:
                github_tools = GitHubTools(github_token)
                tools.extend(github_tools.tools)
        except Exception as e:
            print(f"âš ï¸ GitHubå·¥å…·åˆå§‹åŒ–å¤±è´¥: {e}")
        
        agent = CodeAgent(
            model=self.model,
            tools=tools,
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=2,
            planning_interval=4,
            name="vulnerability_analyzer",
            description="""æ¼æ´åˆ†æä¸“å®¶ï¼Œå…·å¤‡æ·±åšçš„å®‰å…¨æŠ€æœ¯åŠŸåº•ï¼Œèƒ½å¤Ÿç†è§£å¤æ‚çš„æŠ€æœ¯ç»†èŠ‚,ä¸“é—¨è´Ÿè´£æ¼æ´çš„æŠ€æœ¯åˆ†æ, èƒ½å¤Ÿæ·±å…¥åˆ†ææ¼æ´çš„æŠ€æœ¯åŸç†ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
            
            1. æ¼æ´çš„æ ¹æœ¬åŸå› å’Œè§¦å‘æœºåˆ¶
            2. ä»£ç å±‚é¢çš„ç¼ºé™·åˆ†æ
            3. æ”»å‡»å‘é‡å’Œåˆ©ç”¨æ¡ä»¶
            4. ç¼“è§£æªæ–½åˆ†æ
            5. ä¿®å¤ä»£ç åˆ†æ
            6. ç›¸å…³æ¼æ´çš„å¯¹æ¯”ç ”ç©¶
            """,
        )
        
        return agent
    
    def run(self, task):
        """æ‰§è¡Œæ¼æ´æŠ€æœ¯åˆ†æä»»åŠ¡"""
        print(f"ğŸ”¬ å¼€å§‹åˆ†ææ¼æ´æŠ€æœ¯åŸç†...")
        
        enhanced_task = f"""
{task}

---

æ³¨æ„äº‹é¡¹ï¼š
1. åœ¨å¯¹æ¼æ´åšæŠ€æœ¯åŸç†åˆ†ææ—¶ï¼Œä¸è¦å¯¹äº§ç”Ÿæ¼æ´çš„ç›¸å…³ä»£ç ç‰‡æ®µä»¥åŠè¡¥ä¸ä¿®å¤ä»£ç ç‰‡æ®µåšç²¾ç®€ï¼Œè¦å¦‚å®è¾“å‡º
2. åœ¨å¯¹æ¼æ´åšæŠ€æœ¯åŸç†åˆ†ææ—¶ï¼Œä¸è¦é‡‡ç”¨æ€»ç»“çš„è¡¨è¿°æ–¹å¼ï¼Œè¦å¯¹å…¶è¿›è¡Œæ·±å…¥ç»†è‡´çš„åˆ†æå¹¶è¯¦ç»†è¾“å‡ºåˆ†æè¿‡ç¨‹

è¯·æŒ‰ç…§ä»¥ä¸‹markdownç»“æ„è¾“å‡ºæŠ€æœ¯åˆ†æç»“æœï¼š

## æ¼æ´åˆ†æ
æ ¹æ®æœé›†åˆ°çš„ä¿¡æ¯ï¼Œæ€»ç»“æ¼æ´çš„æˆå› åŠæŠ€æœ¯åŸç†
### æŠ€æœ¯åŸç†
æ ¹æ®æ¼æ´äº§ç”Ÿçš„ä»£ç ï¼Œåˆ†ææ¼æ´çš„å…·ä½“æŠ€æœ¯åŸç†ï¼Œéœ€è¦é™„å¸¦æ¼æ´ç›¸å…³çš„ä»£ç å—ï¼Œå¦‚æœæœ‰è¡¥ä¸æˆ–ä¿®å¤ä»£ç ï¼Œåˆ™éœ€è¦å¯¹ä¿®å¤ä»£ç è¿›è¡Œåˆ†æï¼Œæ£€æŸ¥ä¿®å¤æ˜¯å¦å®Œå–„
### æ’æŸ¥æŒ‡å¯¼
æ ¹æ®æ¼æ´äº§ç”Ÿçš„åŸç†ï¼Œç»™å‡ºæ’æŸ¥æŒ‡å¯¼ï¼Œè¦åˆ—å‡ºå…·ä½“çš„æ’æŸ¥æ­¥éª¤ï¼Œéœ€è¦åŒ…å«å¤šç§æ’æŸ¥æ–¹æ³•ï¼Œå¦‚ï¼š
1. æ ¹æ®æ¼æ´ç»„ä»¶ç‰ˆæœ¬è¿›è¡Œæ’æŸ¥
2. æ ¹æ®è§¦å‘æ¼æ´çš„ç°è±¡è¿›è¡Œæ’æŸ¥ï¼Œæ„é€ ç®€å•çš„æ£€æµ‹è„šæœ¬
### ç¼“è§£æªæ–½
æ ¹æ®æ¼æ´çš„æˆå› åŠæŠ€æœ¯åŸç†ï¼Œç»™å‡ºç¼“è§£æªæ–½ï¼Œéœ€è¦åˆ—å‡ºå…·ä½“çš„ç¼“è§£æªæ–½æ‰§è¡Œæ­¥éª¤
### å‚è€ƒé“¾æ¥
ç»™å‡ºè·å¾—ä¸Šè¿°äº‹å®çš„å‚è€ƒé“¾æ¥
1. 
2. 
...
n. 

"""
        
        result = self.agent.run(enhanced_task)
        return result
