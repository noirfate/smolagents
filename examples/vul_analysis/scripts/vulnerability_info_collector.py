"""
æ¼æ´ä¿¡æ¯æ”¶é›†å™¨ - ç¬¬ä¸€é˜¶æ®µ
è´Ÿè´£æ”¶é›†æ¼æ´çš„åŸºç¡€ä¿¡æ¯ï¼ŒåŒ…æ‹¬CVEè¯¦æƒ…ã€CVSSè¯„åˆ†ã€å—å½±å“ç»„ä»¶ç­‰
"""

import os
from smolagents import (
    DuckDuckGoSearchTool,
    CodeAgent,
)

try:
    from scripts.text_web_browser import (
        ArchiveSearchTool,
        FinderTool,
        FindNextTool,
        PageDownTool,
        PageUpTool,
        SimpleTextBrowser,
        VisitTool,
    )
    from scripts.text_inspector_tool import TextInspectorTool
except ImportError:
    # å¦‚æœæ²¡æœ‰è¿™äº›å·¥å…·ï¼Œä½¿ç”¨åŸºç¡€å·¥å…·
    print("âš ï¸ é«˜çº§æµè§ˆå™¨å·¥å…·æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºç¡€æœç´¢åŠŸèƒ½")
    ArchiveSearchTool = None
    SimpleTextBrowser = None


class VulnerabilityInfoCollector:
    """æ¼æ´ä¿¡æ¯æ”¶é›†å™¨"""
    
    def __init__(self, model, max_steps=30):
        self.model = model
        self.max_steps = max_steps
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """åˆ›å»ºä¸“é—¨ç”¨äºæ¼æ´ä¿¡æ¯æ”¶é›†çš„agent"""
        
        # åŸºç¡€å·¥å…·
        tools = [DuckDuckGoSearchTool()]
        
        # å°è¯•æ·»åŠ é«˜çº§æµè§ˆå™¨å·¥å…·
        if SimpleTextBrowser and ArchiveSearchTool:
            try:
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
                browser_config = {
                    "viewport_size": 1024 * 5,
                    "downloads_folder": "downloads",
                    "request_kwargs": {
                        "headers": {"User-Agent": user_agent},
                        "timeout": 300,
                    },
                    "serpapi_key": os.getenv("SERPAPI_API_KEY"),
                    "use_browser_for_text": True,
                }
                
                os.makedirs("./downloads", exist_ok=True)
                browser = SimpleTextBrowser(**browser_config)
                
                tools.extend([
                    VisitTool(browser),
                    PageUpTool(browser),
                    PageDownTool(browser),
                    FinderTool(browser),
                    FindNextTool(browser),
                    ArchiveSearchTool(browser),
                ])
                
                if TextInspectorTool:
                    tools.append(TextInspectorTool(self.model, 100000))
                    
            except Exception as e:
                print(f"âš ï¸ é«˜çº§æµè§ˆå™¨å·¥å…·åˆå§‹åŒ–å¤±è´¥: {e}")
        
        agent = CodeAgent(
            model=self.model,
            tools=tools,
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=2,
            planning_interval=4,
            name="vulnerability_info_collector",
            description="""æ¼æ´ä¿¡æ¯æ”¶é›†ä¸“å®¶ï¼Œä¸“é—¨è´Ÿè´£ä»äº’è”ç½‘ä¸Šæ”¶é›†æ¼æ´ä¿¡æ¯ï¼Œç»™å®ƒä¸€ä¸ªæ¼æ´CVEç¼–å·å³å¯å®Œæˆç›¸å…³çš„ä¿¡æ¯æ”¶é›†å·¥ä½œï¼Œå¯æ”¶é›†çš„ä¿¡æ¯åŒ…æ‹¬ä½†ä¸é™äºï¼š
            
            1. CVEç¼–å·å’Œå®˜æ–¹æè¿°
            2. CVSSè¯„åˆ†å’Œä¸¥é‡ç¨‹åº¦è¯„çº§
            3. æ¼æ´ç±»å‹å’Œåˆ†ç±»
            4. å—å½±å“çš„è½¯ä»¶å’Œç‰ˆæœ¬èŒƒå›´
            5. ä¿®å¤ç‰ˆæœ¬å’Œè¡¥ä¸ä¿¡æ¯
            6. æ¼æ´å‘ç°å’ŒæŠ«éœ²æ—¶é—´çº¿
            7. ç›¸å…³çš„å®‰å…¨å…¬å‘Šå’Œå‚è€ƒé“¾æ¥
            8. æ’æŸ¥å’Œæ£€æµ‹æŒ‡å¯¼
            9. é£é™©å’Œå½±å“è¯„ä¼°
            
            """,
        )
        
        return agent
    
    def run(self, task):
        """æ‰§è¡Œæ¼æ´ä¿¡æ¯æ”¶é›†ä»»åŠ¡"""
        print(f"ğŸ” å¼€å§‹æ”¶é›†æ¼æ´ä¿¡æ¯...")
        
        enhanced_task = f"""
{task}

---

æ³¨æ„äº‹é¡¹ï¼š
1. è¯·ç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ï¼Œä¼˜å…ˆæŸ¥æ‰¾å®˜æ–¹æ¥æº
2. æä¾›æ•°æ®æ¥æºé“¾æ¥
3. äº¤å‰éªŒè¯å¤šä¸ªæ¥æºçš„ä¿¡æ¯ï¼Œä¿è¯ä¿¡æ¯çš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§å’Œæ—¶æ•ˆæ€§
4. ä»¥markdownæ ¼å¼è¾“å‡º

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡ºç»“æœï¼š

## åŸºç¡€ä¿¡æ¯
### æ¼æ´å¤„ç½®ä¼˜å…ˆçº§
ç»¼åˆå¤„ç½®ä¼˜å…ˆçº§ï¼š**ä¼˜å…ˆçº§**ï¼ˆæ ¹æ®æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ã€å…¬å¼€ç¨‹åº¦ã€åˆ©ç”¨æ¡ä»¶ã€äº¤äº’è¦æ±‚ç­‰ç»¼åˆè¯„ä¼°ï¼Œå¯é€‰å€¼ä¸ºä½ã€ä¸­ã€é«˜ï¼‰

| ç±»ç›®             | å€¼                                          |
|------------------|--------------------------------------------------|
| CVEç¼–å·          | æ¼æ´çš„CVEç¼–å· |
| CVSSè¯„åˆ†          | æ¼æ´çš„CVSSè¯„åˆ† |
| æ¼æ´ç±»å‹          |  æ¼æ´æ‰€å±çš„CWEç±»å‹ |
| å…¬å¼€ç¨‹åº¦          |  æ¼æ´çš„å…¬å¼€ç¨‹åº¦ä¸ºå…¬å¼€æˆ–åŠå…¬å¼€ï¼Œå¦‚æœå­˜åœ¨å…¬å¼€çš„æ¼æ´åˆ©ç”¨æˆ–åˆ†ææ–‡ç« åˆ™ä¸ºå…¬å¼€ï¼Œå¦åˆ™ä¸ºåŠå…¬å¼€ |
| åˆ©ç”¨æ¡ä»¶          |  è§¦å‘æ¼æ´éœ€è¦çš„å‰ç½®æ¡ä»¶ï¼Œæ¯”å¦‚éœ€è¦å…·å¤‡ä¸€å®šæƒé™ç­‰ç­‰ |
| äº¤äº’è¦æ±‚          |  è§¦å‘æ¼æ´æ˜¯å¦éœ€è¦ç”¨æˆ·äº¤äº’ï¼Œéœ€è¦æˆ–ä¸éœ€è¦ |

### æ¼æ´æè¿°
æ ¹æ®æ¼æ´å…¬å‘ŠåŠä»äº’è”ç½‘ä¸Šæ”¶é›†çš„ä¿¡æ¯å¯¹æ¼æ´è¿›è¡Œå‡†ç¡®çš„æè¿°

### å½±å“ç‰ˆæœ¬
æ¼æ´å½±å“çš„ç»„ä»¶åŠå…¶å½±å“ç‰ˆæœ¬èŒƒå›´

### ä¿®å¤ç‰ˆæœ¬
æ¼æ´çš„ä¿®å¤ç‰ˆæœ¬

### å‚è€ƒé“¾æ¥
ç»™å‡ºè·å¾—ä¸Šè¿°äº‹å®çš„å‚è€ƒé“¾æ¥
1. 
2. 
...
n. 

"""
        
        result = self.agent.run(enhanced_task)
        return result
