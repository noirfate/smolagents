# æ™ºèƒ½å¼‚æ­¥Agentç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ§  æ ¸å¿ƒç†å¿µ

è®© **CodeAgent ä½œä¸ºä¸»æ§åˆ¶å™¨**ï¼Œè‡ªä¸»åœ°è¿›è¡Œä»»åŠ¡æ‹†è§£ã€åˆ†å‘å’Œåè°ƒï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ä»»åŠ¡ã€‚Agent ä¼šï¼š

1. **æ™ºèƒ½åˆ†æ**ï¼šåˆ†æå¤æ‚ä»»åŠ¡ï¼Œè¯†åˆ«å¯å¹¶è¡Œæ‰§è¡Œçš„å­ä»»åŠ¡
2. **åŠ¨æ€åˆ†å‘**ï¼šæ ¹æ®ä»»åŠ¡æ€§è´¨é€‰æ‹©åˆé€‚çš„å·¥å…·æˆ–managed agents
3. **è‡ªä¸»ç­‰å¾…**ï¼šä½¿ç”¨sleepå’Œwait_for_taskså·¥å…·æ™ºèƒ½ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆ
4. **ç»“æœæ•´åˆ**ï¼šæ”¶é›†å¹¶æ•´åˆå¼‚æ­¥ä»»åŠ¡ç»“æœ

## ğŸ› ï¸ ç³»ç»Ÿç»„ä»¶

### æ ¸å¿ƒå·¥å…·é›†
- `submit_task` - æäº¤å¼‚æ­¥ä»»åŠ¡ï¼ˆç›´æ¥è¿”å›ä»»åŠ¡IDï¼‰
- `wait_for_tasks` - æ™ºèƒ½ç­‰å¾…æŒ‡å®šä»»åŠ¡å®Œæˆ
- `sleep` - ç®€å•ä¼‘çœ ç­‰å¾…
- `get_task_results` - æ‰¹é‡è·å–ä»»åŠ¡ç»“æœï¼ˆç›´æ¥è¿”å›å­—å…¸ï¼‰
- `check_task` - æ£€æŸ¥å•ä¸ªä»»åŠ¡çŠ¶æ€
- `list_tasks` - åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡

### AsyncAgent
åŒ…è£…CodeAgentï¼Œæä¾›ï¼š
- è‡ªåŠ¨çš„ç³»ç»Ÿæç¤ºå¢å¼º
- æ™ºèƒ½å¼‚æ­¥å·¥å…·é›†æˆ
- ä»»åŠ¡ç®¡ç†å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ™ºèƒ½ä»»åŠ¡æ‹†è§£å’Œåè°ƒèƒ½åŠ›

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ç”¨æ³•

```python
import os
from dotenv import load_dotenv
from async_task_system import create_async_agent
from smolagents import LiteLLMModel

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv(override=True)

# åˆ›å»ºæ™ºèƒ½å¼‚æ­¥CodeAgent
model = LiteLLMModel(
    model_id="litellm_proxy/gpt-3.5-turbo",
    api_key=os.getenv("API_KEY"),
    base_url=os.getenv("BASE_URL"),
    max_completion_tokens=8192
)

async_agent = create_async_agent(
    tools=[your_tools],
    managed_agents=[your_agents],
    model=model,
    max_workers=3
)

# è®©Agentè‡ªä¸»å¤„ç†å¤æ‚ä»»åŠ¡
result = async_agent.run_with_async_guidance("""
æˆ‘éœ€è¦åˆ†æ5ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ªåˆ†æéœ€è¦3-5ç§’ã€‚
è¯·è®¾è®¡ä¸€ä¸ªé«˜æ•ˆçš„å¹¶è¡Œå¤„ç†æ–¹æ¡ˆã€‚
""")

async_agent.shutdown()
```

### Agentçš„æ™ºèƒ½è¡Œä¸º

Agentç°åœ¨ä¼šè‡ªåŠ¨ï¼š

1. **è¯†åˆ«å¹¶è¡Œæœºä¼š**
   ```
   ç”¨æˆ·ï¼šåˆ†æ3ä¸ªæ•°æ®é›†
   Agentï¼šæˆ‘å‘ç°è¿™3ä¸ªåˆ†æå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œè®©æˆ‘æäº¤3ä¸ªå¼‚æ­¥ä»»åŠ¡...
   ```

2. **æ™ºèƒ½ç­‰å¾…**
   ```python
   # Agentä¼šè¿™æ ·åšï¼š
   task1 = submit_task("tool", "analyze_dataset", {...})  # ç›´æ¥è¿”å›ä»»åŠ¡ID
   task2 = submit_task("tool", "analyze_dataset", {...})  
   task3 = submit_task("tool", "analyze_dataset", {...})
   
   wait_for_tasks([task1, task2, task3], max_wait_time=30)
   results = get_task_results([task1, task2, task3])  # ç›´æ¥è¿”å›å­—å…¸
   ```

3. **é”™è¯¯å¤„ç†å’Œé‡è¯•**
   ```
   Agentï¼šæ£€æµ‹åˆ°ä»»åŠ¡å¤±è´¥ï¼Œè®©æˆ‘æ£€æŸ¥é”™è¯¯åŸå› å¹¶é‡æ–°æäº¤...
   ```

## ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ‰¹é‡æ•°æ®å¤„ç†
```python
task = """
æˆ‘æœ‰10ä¸ªæ•°æ®æ–‡ä»¶éœ€è¦å¤„ç†ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤„ç†åŒ…æ‹¬ï¼š
1. æ•°æ®æ¸…æ´—
2. ç»Ÿè®¡åˆ†æ  
3. ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨

è¯·ä¼˜åŒ–å¤„ç†æµç¨‹ï¼Œå‡å°‘æ€»ä½“æ—¶é—´ã€‚
"""

result = async_agent.run_with_async_guidance(task)
```

**Agentä¼šè‡ªåŠ¨**ï¼š
- è¯†åˆ«å‡º30ä¸ªå­ä»»åŠ¡ï¼ˆ10æ–‡ä»¶ Ã— 3æ­¥éª¤ï¼‰
- åˆ†æä¾èµ–å…³ç³»ï¼ˆæ¸…æ´—â†’åˆ†æâ†’å¯è§†åŒ–ï¼‰
- è®¾è®¡æµæ°´çº¿ï¼šå…ˆå¹¶è¡Œæ¸…æ´—ï¼Œå†å¹¶è¡Œåˆ†æï¼Œæœ€åå¹¶è¡Œç”Ÿæˆå›¾è¡¨

### åœºæ™¯2ï¼šå¤šæºæ•°æ®æ•´åˆ
```python
task = """
æˆ‘éœ€è¦ä»ä»¥ä¸‹æ•°æ®æºè·å–æ•°æ®å¹¶æ•´åˆï¼š
- æ•°æ®åº“Aï¼šç”¨æˆ·ä¿¡æ¯
- æ•°æ®åº“Bï¼šäº¤æ˜“è®°å½•
- API Cï¼šå®æ—¶å¸‚åœºæ•°æ®
- æ–‡ä»¶Dï¼šå†å²æ•°æ®

è¯·é«˜æ•ˆåœ°è·å–å¹¶æ•´åˆè¿™äº›æ•°æ®ã€‚
"""
```

**Agentä¼šè‡ªåŠ¨**ï¼š
- å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®æº
- ä½¿ç”¨wait_for_tasksç­‰å¾…æ‰€æœ‰æ•°æ®è·å–å®Œæˆ
- æ•´åˆæ•°æ®å¹¶ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

### åœºæ™¯3ï¼šå¤åˆåˆ†æä»»åŠ¡
```python
task = """
å¯¹æˆ‘ä»¬çš„ç”µå•†å¹³å°è¿›è¡Œå…¨é¢åˆ†æï¼š
1. ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆéœ€è¦æœºå™¨å­¦ä¹ ä¸“å®¶ï¼‰
2. é”€å”®è¶‹åŠ¿åˆ†æ
3. åº“å­˜ä¼˜åŒ–å»ºè®®
4. ç«äº‰å¯¹æ‰‹åˆ†æ
5. ç»¼åˆæˆ˜ç•¥æŠ¥å‘Š

æ¯ä¸ªåˆ†æéƒ½æ¯”è¾ƒè€—æ—¶ï¼Œè¯·ä¼˜åŒ–æ‰§è¡Œã€‚
"""
```

**Agentä¼šè‡ªåŠ¨**ï¼š
- è¯†åˆ«ç‹¬ç«‹ä»»åŠ¡ï¼ˆ1-4å¯å¹¶è¡Œï¼‰
- æäº¤ç»™åˆé€‚çš„å·¥å…·/agents
- ç­‰å¾…æ‰€æœ‰åˆ†æå®Œæˆ
- æ•´åˆç»“æœç”Ÿæˆç»¼åˆæŠ¥å‘Š

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ç³»ç»Ÿæç¤º
```python
async_agent = create_async_agent(
    tools=tools,
    model=model,
    instructions="""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é¡¹ç›®ç»ç†ï¼Œæ“…é•¿ä»»åŠ¡åˆ†è§£å’Œå¹¶è¡Œå¤„ç†ã€‚
æ€»æ˜¯ä¼˜å…ˆè€ƒè™‘æ•ˆç‡å’Œå¹¶è¡Œæ‰§è¡Œçš„å¯èƒ½æ€§ã€‚
"""
)
```

### è°ƒæ•´å¹¶å‘åº¦
```python
# é«˜å¹¶å‘åœºæ™¯
async_agent = create_async_agent(
    max_workers=8,  # æ›´å¤šå·¥ä½œçº¿ç¨‹
    model=model
)
```

### ç›‘æ§å’Œè°ƒè¯•
```python
# è·å–å®æ—¶ç»Ÿè®¡
stats = async_agent.task_manager.get_statistics()
print(f"Running tasks: {stats['running']}")

# æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
result = async_agent.run("è¯·ä½¿ç”¨list_taskså·¥å…·æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡çŠ¶æ€")
```

## ğŸ’¡ Agentè¡Œä¸ºæ¨¡å¼

### å…¸å‹çš„Agentå·¥ä½œæµç¨‹

1. **ä»»åŠ¡åˆ†æé˜¶æ®µ**
   ```
   Agent: åˆ†ææ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å‘ç°å¯ä»¥å°†æ­¤ä»»åŠ¡åˆ†è§£ä¸ºä»¥ä¸‹å­ä»»åŠ¡...
   ```

2. **å¹¶è¡Œæ‰§è¡Œé˜¶æ®µ**
   ```python
   # Agentä¼šæ‰§è¡Œç±»ä¼¼çš„ä»£ç ï¼š
   task_ids = []
   for subtask in subtasks:
       task_id = submit_task(subtask.type, subtask.name, subtask.args)
       task_ids.append(task_id)
   ```

3. **æ™ºèƒ½ç­‰å¾…é˜¶æ®µ**
   ```python
   # Agenté€‰æ‹©åˆé€‚çš„ç­‰å¾…ç­–ç•¥ï¼š
   wait_for_tasks(task_ids, max_wait_time=60)
   # æˆ–è€…
   sleep(5, reason="ç­‰å¾…æ•°æ®å¤„ç†ä»»åŠ¡å®Œæˆ")
   ```

4. **ç»“æœæ”¶é›†é˜¶æ®µ**
   ```python
   results = get_task_results(task_ids)  # ç›´æ¥è¿”å›å­—å…¸ {task_id: result}
   result1 = results[task_ids[0]]  # ç›´æ¥ä½¿ç”¨ç»“æœ
   ```

5. **æ•´åˆè¾“å‡ºé˜¶æ®µ**
   ```
   Agent: åŸºäºä»¥ä¸Šå¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼Œæˆ‘ä¸ºæ‚¨æ•´åˆäº†æœ€ç»ˆæŠ¥å‘Š...
   ```

## âš ï¸ æœ€ä½³å®è·µ

1. **æ˜ç¡®ä»»åŠ¡è¾¹ç•Œ**ï¼šæ¸…æ¥šæè¿°ä½ çš„éœ€æ±‚ï¼Œè®©Agentæ›´å¥½åœ°è¯†åˆ«å¹¶è¡Œæœºä¼š

2. **åˆç†è®¾ç½®è¶…æ—¶**ï¼šå¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œè®¾ç½®åˆç†çš„max_wait_time

3. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼šæ ¹æ®ç³»ç»Ÿèµ„æºè°ƒæ•´max_workers

4. **é”™è¯¯æ¢å¤**ï¼šAgentä¼šè‡ªåŠ¨å¤„ç†ä»»åŠ¡å¤±è´¥ï¼Œä½†å¤æ‚åœºæ™¯å¯èƒ½éœ€è¦äººå·¥å¹²é¢„

5. **æ¸è¿›å¼å¤æ‚åº¦**ï¼šä»ç®€å•ä»»åŠ¡å¼€å§‹ï¼Œé€æ­¥å°è¯•æ›´å¤æ‚çš„å¹¶è¡Œåœºæ™¯

## ğŸš€ ç¤ºä¾‹å¯¹è¯

```
ç”¨æˆ·ï¼šæˆ‘éœ€è¦åˆ†æå…¬å¸çš„å­£åº¦ä¸šç»©ï¼ŒåŒ…æ‹¬é”€å”®ã€å¸‚åœºã€è¿è¥ä¸‰ä¸ªç»´åº¦çš„æ•°æ®

Agentï¼šæˆ‘æ¥ä¸ºæ‚¨è®¾è®¡ä¸€ä¸ªé«˜æ•ˆçš„åˆ†ææ–¹æ¡ˆï¼š

1. é¦–å…ˆï¼Œæˆ‘è¯†åˆ«åˆ°è¿™ä¸‰ä¸ªç»´åº¦çš„åˆ†æå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
2. è®©æˆ‘æäº¤ä¸‰ä¸ªå¼‚æ­¥ä»»åŠ¡...

# æäº¤ä»»åŠ¡ï¼ˆç›´æ¥è·å¾—ä»»åŠ¡IDï¼‰
sales_task = submit_task("tool", "analyze_sales", {"quarter": "Q1"})
market_task = submit_task("tool", "analyze_market", {"quarter": "Q1"}) 
ops_task = submit_task("tool", "analyze_operations", {"quarter": "Q1"})

# æ™ºèƒ½ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
wait_for_tasks([sales_task, market_task, ops_task], max_wait_time=60)

# ç›´æ¥è·å–ç»“æœå­—å…¸
results = get_task_results([sales_task, market_task, ops_task])

æ‰€æœ‰åˆ†æä»»åŠ¡å·²å®Œæˆï¼åŸºäºä»¥ä¸‹ç»“æœï¼š
- é”€å”®åˆ†æï¼š{results[sales_task]}
- å¸‚åœºåˆ†æï¼š{results[market_task]}
- è¿è¥åˆ†æï¼š{results[ops_task]}

è®©æˆ‘æ•´åˆè¿™äº›ç»“æœä¸ºæ‚¨ç”Ÿæˆç»¼åˆçš„å­£åº¦ä¸šç»©æŠ¥å‘Š...
```

è¿™å°±æ˜¯æ™ºèƒ½å¼‚æ­¥Agentçš„å¼ºå¤§ä¹‹å¤„ - **Agentæˆä¸ºäº†ä»»åŠ¡åè°ƒè€…**ï¼Œè‡ªåŠ¨å¤„ç†å¤æ‚çš„å¹¶è¡Œä»»åŠ¡æµç¨‹ï¼

## ğŸ” OpenTelemetry è¿½è¸ªæ”¯æŒ

### é—®é¢˜ï¼šå¼‚æ­¥ä»»åŠ¡ä¸­ Trace æ–­è£‚

åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶ï¼ŒOpenTelemetry çš„ trace context é»˜è®¤ä¸ä¼šè‡ªåŠ¨ä¼ é€’åˆ°æ–°çº¿ç¨‹ï¼Œå¯¼è‡´ï¼š
- Phoenix/å…¶ä»–ç›‘æ§å¹³å°ä¸­åªèƒ½çœ‹åˆ°éƒ¨åˆ† trace
- ä¸» agent å’Œå¼‚æ­¥ä»»åŠ¡çš„ trace ä¸è¿è´¯
- éš¾ä»¥å®Œæ•´è¿½è¸ªæ•´ä¸ªä»»åŠ¡æµç¨‹

### è§£å†³æ–¹æ¡ˆï¼šè‡ªåŠ¨ Context ä¼ é€’

ç³»ç»Ÿå·²è‡ªåŠ¨é›†æˆ OpenTelemetry context ä¼ é€’ï¼š

1. **æäº¤ä»»åŠ¡æ—¶æ•è· context**ï¼š
   - åœ¨ `submit_task` æ—¶è‡ªåŠ¨æ•è·å½“å‰çš„ OpenTelemetry context
   - å°† context å­˜å‚¨åœ¨ `TaskInfo` ä¸­

2. **æ‰§è¡Œä»»åŠ¡æ—¶æ¢å¤ context**ï¼š
   - åœ¨ `_execute_task` ä¸­æ¢å¤çˆ¶ä»»åŠ¡çš„ context
   - å¼‚æ­¥ä»»åŠ¡çš„ trace ä¼šæ­£ç¡®å…³è”åˆ°ä¸»ä»»åŠ¡
   - æ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ¸…ç† context

3. **å®Œå…¨é€æ˜**ï¼š
   - æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
   - è‡ªåŠ¨æ£€æµ‹ OpenTelemetry æ˜¯å¦å¯ç”¨
   - å³ä½¿æ²¡æœ‰å®‰è£… OpenTelemetry ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ

### ä½¿ç”¨ç¤ºä¾‹

```python
# å¯ç”¨ç›‘æ§ï¼ˆåœ¨åˆ›å»º agent ä¹‹å‰ï¼‰
from phoenix.otel import register
from openinference.instrumentation.smolagents import SmolagentsInstrumentor

register(
   project_name=project_name,
   endpoint="http://localhost:6006/v1/traces",
   auto_instrument=True,
   set_global_tracer_provider=False
)
SmolagentsInstrumentor().instrument()

# æ­£å¸¸ä½¿ç”¨å¼‚æ­¥ agent
async_agent = create_async_agent(tools=tools, model=model)
result = async_agent.run_with_async_guidance("ä½ çš„ä»»åŠ¡")

# åœ¨ Phoenix UI ä¸­æŸ¥çœ‹å®Œæ•´ã€è¿è´¯çš„ trace
# http://localhost:6006
```

### æ•ˆæœ

âœ… **å®Œæ•´çš„ Trace é“¾**ï¼šä»ä¸» agent åˆ°æ‰€æœ‰å¼‚æ­¥å­ä»»åŠ¡
âœ… **æ­£ç¡®çš„çˆ¶å­å…³ç³»**ï¼šæ¸…æ™°å±•ç¤ºä»»åŠ¡ä¾èµ–å’Œè°ƒç”¨å…³ç³»
âœ… **è¿è´¯çš„æ—¶é—´çº¿**ï¼šå‡†ç¡®æ˜¾ç¤ºå¹¶è¡Œæ‰§è¡Œçš„æ—¶åºå…³ç³»
âœ… **å®Œæ•´çš„ Span ä¿¡æ¯**ï¼šLLM è°ƒç”¨ã€å·¥å…·æ‰§è¡Œã€é”™è¯¯ä¿¡æ¯å…¨éƒ¨å¯è§

### æŠ€æœ¯ç»†èŠ‚

- ä½¿ç”¨ `opentelemetry.context` è¿›è¡Œ context ä¼ é€’
- åœ¨çº¿ç¨‹è¾¹ç•Œæ˜¾å¼ä¼ é€’å’Œæ¢å¤ context
- ä½¿ç”¨ `attach/detach` ç¡®ä¿ context æ­£ç¡®éš”ç¦»
- å¤±è´¥æ—¶æœ‰ fallbackï¼Œä¸å½±å“ä»»åŠ¡æ‰§è¡Œ