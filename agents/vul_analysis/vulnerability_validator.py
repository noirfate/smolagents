"""
æ¼æ´åˆ†æè´¨é‡æ ¡éªŒå™¨
è´Ÿè´£æ£€æŸ¥æ¯ä¸ªé˜¶æ®µçš„åˆ†æç»“æœè´¨é‡ï¼Œç¡®ä¿è¾¾åˆ°é¢„æœŸæ ‡å‡†
"""

import re
from typing import Dict, List, Tuple
from smolagents import (
    CodeAgent,
)


class VulnerabilityAnalysisValidator:
    """æ¼æ´åˆ†æè´¨é‡æ ¡éªŒå™¨"""
    
    def __init__(self, model, max_steps=15):
        self.model = model
        self.max_steps = max_steps
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """åˆ›å»ºä¸“é—¨ç”¨äºè´¨é‡æ ¡éªŒçš„agent"""
        agent = CodeAgent(
            model=self.model,
            tools=[],
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=1,
            planning_interval=3,
            name="vulnerability_validator",
            description="""æ¼æ´åˆ†æè´¨é‡æ ¡éªŒä¸“å®¶ï¼Œè´Ÿè´£è¯„ä¼°æ¼æ´åˆ†æç»“æœçš„å®Œæ•´æ€§ã€å‡†ç¡®æ€§å’Œå®ç”¨æ€§ã€‚
            
            èƒ½åŠ›åŒ…æ‹¬ï¼š
            1. è¯„ä¼°ä¿¡æ¯æ”¶é›†çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
            2. æ£€æŸ¥æŠ€æœ¯åˆ†æçš„æ·±åº¦å’Œé€»è¾‘æ€§
            3. éªŒè¯POCä»£ç çš„å¯æ‰§è¡Œæ€§å’Œæœ‰æ•ˆæ€§
            4. è¯†åˆ«åˆ†æä¸­çš„ç¼ºå¤±é¡¹å’Œé”™è¯¯
            """,
        )
        
        return agent
    
    def validate_stage1_info_collection(self, result: str, vulnerability_id: str) -> Tuple[bool, List[str], int, str]:
        """
        éªŒè¯ç¬¬ä¸€é˜¶æ®µä¿¡æ¯æ”¶é›†ç»“æœ
        
        Returns:
            Tuple[bool, List[str], int, str]: (æ˜¯å¦é€šè¿‡, é—®é¢˜åˆ—è¡¨, è´¨é‡è¯„åˆ†, è¡Œä¸ºæŒ‡å¯¼)
        """
        print("ğŸ” æ ¡éªŒç¬¬ä¸€é˜¶æ®µï¼šæ¼æ´ä¿¡æ¯æ”¶é›†è´¨é‡...")
        
        validation_task = f"""
è¯·è¯„ä¼°ä»¥ä¸‹æ¼æ´ä¿¡æ¯æ”¶é›†ç»“æœçš„è´¨é‡ï¼š

æ¼æ´ID: {vulnerability_id}

åˆ†æç»“æœ:
{result}

---

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯„ä¼°ï¼š

1. **åŸºç¡€ä¿¡æ¯å®Œæ•´æ€§** (25åˆ†)ï¼š
   - CVEç¼–å·æ˜¯å¦æ­£ç¡®
   - CVSSè¯„åˆ†æ˜¯å¦å‡†ç¡®
   - æ¼æ´ç±»å‹åˆ†ç±»æ˜¯å¦æ­£ç¡®
   - å½±å“ç‰ˆæœ¬å’Œä¿®å¤ç‰ˆæœ¬æ˜¯å¦æ˜ç¡®

2. **æè¿°å‡†ç¡®æ€§** (25åˆ†)ï¼š
   - æ¼æ´æè¿°æ˜¯å¦å‡†ç¡®è¯¦ç»†
   - æŠ€æœ¯åŸç†æ¦‚è¿°æ˜¯å¦æ­£ç¡®
   - å½±å“èŒƒå›´è¯„ä¼°æ˜¯å¦åˆç†

3. **å‚è€ƒèµ„æ–™è´¨é‡** (25åˆ†)ï¼š
   - æ˜¯å¦åŒ…å«å®˜æ–¹å®‰å…¨å…¬å‘Šé“¾æ¥
   - æ˜¯å¦æœ‰NVDç­‰æƒå¨æ¥æº
   - å‚è€ƒé“¾æ¥æ˜¯å¦æœ‰æ•ˆå¯è®¿é—®

4. **é£é™©è¯„ä¼°åˆç†æ€§** (25åˆ†)ï¼š
   - å¤„ç½®ä¼˜å…ˆçº§æ˜¯å¦åˆç†
   - åˆ©ç”¨æ¡ä»¶åˆ†ææ˜¯å¦å‡†ç¡®
   - äº¤äº’è¦æ±‚åˆ¤æ–­æ˜¯å¦æ­£ç¡®

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºè¯„ä¼°ç»“æœï¼š

## è´¨é‡è¯„ä¼°ç»“æœ

### æ€»ä½“è¯„åˆ†
æ€»åˆ†ï¼šX/100åˆ†

### å„ç»´åº¦è¯„åˆ†
- åŸºç¡€ä¿¡æ¯å®Œæ•´æ€§ï¼šX/25åˆ†
- æè¿°å‡†ç¡®æ€§ï¼šX/25åˆ†  
- å‚è€ƒèµ„æ–™è´¨é‡ï¼šX/25åˆ†
- é£é™©è¯„ä¼°åˆç†æ€§ï¼šX/25åˆ†

### å­˜åœ¨é—®é¢˜
1. é—®é¢˜æè¿°1
2. é—®é¢˜æè¿°2
...

### æ”¹è¿›å»ºè®®
1. æ”¹è¿›å»ºè®®1
2. æ”¹è¿›å»ºè®®2
...

### ä¸‹ä¸€è½®æ‰§è¡ŒæŒ‡å¯¼
è¯·ä¸ºä¸‹ä¸€è½®æ‰§è¡Œæä¾›å…·ä½“çš„è¡Œä¸ºæŒ‡å¯¼ï¼ŒåŒ…æ‹¬ï¼š
- éœ€è¦é‡ç‚¹å…³æ³¨çš„ä¿¡æ¯æ”¶é›†æ–¹å‘
- éœ€è¦è¡¥å……çš„å…·ä½“å†…å®¹
- éœ€è¦ä¿®æ­£çš„é”™è¯¯ä¿¡æ¯
- å»ºè®®çš„æœç´¢å…³é”®è¯å’ŒæŸ¥æ‰¾ç­–ç•¥
- å…¶ä»–å…·ä½“çš„æ‰§è¡Œå»ºè®®

### æ˜¯å¦é€šè¿‡
é€šè¿‡æ ‡å‡†ï¼šæ€»åˆ†â‰¥75åˆ†ä¸”æ— ä¸¥é‡é”™è¯¯
ç»“æœï¼šé€šè¿‡/ä¸é€šè¿‡
"""
        
        validation_result = self.agent.run(validation_task)
        return self._parse_validation_result(validation_result)
    
    def validate_stage2_analysis(self, result: str, vulnerability_id: str) -> Tuple[bool, List[str], int, str]:
        """
        éªŒè¯ç¬¬äºŒé˜¶æ®µæŠ€æœ¯åˆ†æç»“æœ
        
        Returns:
            Tuple[bool, List[str], int, str]: (æ˜¯å¦é€šè¿‡, é—®é¢˜åˆ—è¡¨, è´¨é‡è¯„åˆ†, è¡Œä¸ºæŒ‡å¯¼)
        """
        print("ğŸ”¬ æ ¡éªŒç¬¬äºŒé˜¶æ®µï¼šæ¼æ´æŠ€æœ¯åˆ†æè´¨é‡...")
        
        validation_task = f"""
è¯·è¯„ä¼°ä»¥ä¸‹æ¼æ´æŠ€æœ¯åˆ†æç»“æœçš„è´¨é‡ï¼š

æ¼æ´ID: {vulnerability_id}

åˆ†æç»“æœ:
{result}

---

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯„ä¼°ï¼š

1. **æºç åˆ†ææ·±åº¦** (30åˆ†)ï¼š
   - æ˜¯å¦åŒ…å«çœŸå®çš„æ¼æ´ä»£ç ç‰‡æ®µ
   - ä»£ç åˆ†ææ˜¯å¦é€è¡Œè¯¦ç»†
   - æ˜¯å¦åˆ†æäº†ä¿®å¤è¡¥ä¸ä»£ç 
   - ä¿®å¤å‰åå¯¹æ¯”æ˜¯å¦æ¸…æ™°

2. **æŠ€æœ¯åŸç†å‡†ç¡®æ€§** (30åˆ†)ï¼š
   - æ¼æ´è§¦å‘æœºåˆ¶åˆ†ææ˜¯å¦æ­£ç¡®
   - æ•°æ®æµå’Œæ§åˆ¶æµåˆ†ææ˜¯å¦å‡†ç¡®
   - æ—¶åºå’Œæ¡ä»¶åˆ†ææ˜¯å¦åˆç†
   - æ ¹æœ¬åŸå› å®šä½æ˜¯å¦å‡†ç¡®

3. **æ’æŸ¥æŒ‡å¯¼å®ç”¨æ€§** (20åˆ†)ï¼š
   - æ˜¯å¦æä¾›å¤šç§æ’æŸ¥æ–¹æ³•
   - æ£€æµ‹è„šæœ¬æ˜¯å¦å¯è¡Œ
   - æ’æŸ¥æ­¥éª¤æ˜¯å¦å…·ä½“å¯æ“ä½œ

4. **ç¼“è§£æªæ–½å®Œæ•´æ€§** (20åˆ†)ï¼š
   - æ˜¯å¦åŒ…å«æ ¹æœ¬æ€§ä¿®å¤æ–¹æ¡ˆ
   - ä¸´æ—¶ç¼“è§£æªæ–½æ˜¯å¦å¯è¡Œ
   - é˜²æŠ¤å»ºè®®æ˜¯å¦å…¨é¢

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºè¯„ä¼°ç»“æœï¼š

## è´¨é‡è¯„ä¼°ç»“æœ

### æ€»ä½“è¯„åˆ†
æ€»åˆ†ï¼šX/100åˆ†

### å„ç»´åº¦è¯„åˆ†
- æºç åˆ†ææ·±åº¦ï¼šX/30åˆ†
- æŠ€æœ¯åŸç†å‡†ç¡®æ€§ï¼šX/30åˆ†
- æ’æŸ¥æŒ‡å¯¼å®ç”¨æ€§ï¼šX/20åˆ†
- ç¼“è§£æªæ–½å®Œæ•´æ€§ï¼šX/20åˆ†

### å­˜åœ¨é—®é¢˜
1. é—®é¢˜æè¿°1
2. é—®é¢˜æè¿°2
...

### æ”¹è¿›å»ºè®®
1. æ”¹è¿›å»ºè®®1
2. æ”¹è¿›å»ºè®®2
...

### ä¸‹ä¸€è½®æ‰§è¡ŒæŒ‡å¯¼
è¯·ä¸ºä¸‹ä¸€è½®æ‰§è¡Œæä¾›å…·ä½“çš„è¡Œä¸ºæŒ‡å¯¼ï¼ŒåŒ…æ‹¬ï¼š
- éœ€è¦æ·±å…¥åˆ†æçš„æºç ä½ç½®å’Œæ–‡ä»¶
- éœ€è¦æŸ¥æ‰¾çš„å…·ä½“commitæˆ–è¡¥ä¸é“¾æ¥
- éœ€è¦é‡ç‚¹å…³æ³¨çš„æŠ€æœ¯ç»†èŠ‚
- å»ºè®®çš„ä»£ç åˆ†ææ–¹æ³•å’Œå·¥å…·
- éœ€è¦è¡¥å……çš„æŠ€æœ¯åŸç†è§£é‡Š
- å…¶ä»–å…·ä½“çš„åˆ†æå»ºè®®

### æ˜¯å¦é€šè¿‡
é€šè¿‡æ ‡å‡†ï¼šæ€»åˆ†â‰¥75åˆ†ä¸”æºç åˆ†ææ·±åº¦â‰¥20åˆ†
ç»“æœï¼šé€šè¿‡/ä¸é€šè¿‡
"""
        
        validation_result = self.agent.run(validation_task)
        return self._parse_validation_result(validation_result)
    
    def validate_stage3_exploitation(self, result: str, vulnerability_id: str) -> Tuple[bool, List[str], int, str]:
        """
        éªŒè¯ç¬¬ä¸‰é˜¶æ®µåˆ©ç”¨åˆ†æç»“æœ
        
        Returns:
            Tuple[bool, List[str], int, str]: (æ˜¯å¦é€šè¿‡, é—®é¢˜åˆ—è¡¨, è´¨é‡è¯„åˆ†, è¡Œä¸ºæŒ‡å¯¼)
        """
        print("âš”ï¸ æ ¡éªŒç¬¬ä¸‰é˜¶æ®µï¼šæ¼æ´åˆ©ç”¨åˆ†æè´¨é‡...")
        
        validation_task = f"""
è¯·è¯„ä¼°ä»¥ä¸‹æ¼æ´åˆ©ç”¨åˆ†æç»“æœçš„è´¨é‡ï¼š

æ¼æ´ID: {vulnerability_id}

åˆ†æç»“æœ:
{result}

---

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯„ä¼°ï¼š

1. **å¤ç°ç¯å¢ƒå®Œæ•´æ€§** (25åˆ†)ï¼š
   - Dockerfileæ˜¯å¦å®Œæ•´å¯ç”¨
   - ç¯å¢ƒé…ç½®æ˜¯å¦è¯¦ç»†
   - ä¾èµ–å®‰è£…æ˜¯å¦å®Œæ•´
   - ç¯å¢ƒæ­å»ºæ­¥éª¤æ˜¯å¦æ¸…æ™°

2. **POCä»£ç è´¨é‡** (35åˆ†)ï¼š
   - POCä»£ç æ˜¯å¦å®Œæ•´å¯æ‰§è¡Œ
   - ä»£ç é€»è¾‘æ˜¯å¦æ­£ç¡®
   - æ˜¯å¦åŒ…å«é”™è¯¯å¤„ç†
   - æ˜¯å¦æœ‰æˆåŠŸéªŒè¯æœºåˆ¶
   - æŠ€æœ¯ç»†èŠ‚è§£é‡Šæ˜¯å¦è¯¦ç»†

3. **åˆ©ç”¨æ­¥éª¤å‡†ç¡®æ€§** (25åˆ†)ï¼š
   - æ“ä½œæ­¥éª¤æ˜¯å¦è¯¦ç»†å…·ä½“
   - æ—¶åºè¦æ±‚æ˜¯å¦æ˜ç¡®
   - è§¦å‘æ¡ä»¶æ˜¯å¦å‡†ç¡®
   - é¢„æœŸç»“æœæ˜¯å¦æ˜ç¡®

4. **å®ç”¨æ€§å’Œå¯æ“ä½œæ€§** (15åˆ†)ï¼š
   - æ˜¯å¦æä¾›å®Œæ•´çš„æ“ä½œæŒ‡å—
   - éªŒè¯æ–¹æ³•æ˜¯å¦å¯è¡Œ
   - æ˜¯å¦è€ƒè™‘äº†å®é™…ç¯å¢ƒå·®å¼‚

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºè¯„ä¼°ç»“æœï¼š

## è´¨é‡è¯„ä¼°ç»“æœ

### æ€»ä½“è¯„åˆ†
æ€»åˆ†ï¼šX/100åˆ†

### å„ç»´åº¦è¯„åˆ†
- å¤ç°ç¯å¢ƒå®Œæ•´æ€§ï¼šX/25åˆ†
- POCä»£ç è´¨é‡ï¼šX/35åˆ†
- åˆ©ç”¨æ­¥éª¤å‡†ç¡®æ€§ï¼šX/25åˆ†
- å®ç”¨æ€§å’Œå¯æ“ä½œæ€§ï¼šX/15åˆ†

### å­˜åœ¨é—®é¢˜
1. é—®é¢˜æè¿°1
2. é—®é¢˜æè¿°2
...

### æ”¹è¿›å»ºè®®
1. æ”¹è¿›å»ºè®®1
2. æ”¹è¿›å»ºè®®2
...

### ä¸‹ä¸€è½®æ‰§è¡ŒæŒ‡å¯¼
è¯·ä¸ºä¸‹ä¸€è½®æ‰§è¡Œæä¾›å…·ä½“çš„è¡Œä¸ºæŒ‡å¯¼ï¼ŒåŒ…æ‹¬ï¼š
- éœ€è¦æœç´¢çš„POCä»£ç ä»“åº“å’Œèµ„æº
- éœ€è¦å®Œå–„çš„ç¯å¢ƒé…ç½®å’Œä¾èµ–
- éœ€è¦ä¿®æ­£çš„POCä»£ç é€»è¾‘
- éœ€è¦è¡¥å……çš„åˆ©ç”¨æ­¥éª¤ç»†èŠ‚
- å»ºè®®çš„éªŒè¯æ–¹æ³•å’Œæµ‹è¯•ç­–ç•¥
- å…¶ä»–å…·ä½“çš„åˆ©ç”¨åˆ†æå»ºè®®

### æ˜¯å¦é€šè¿‡
é€šè¿‡æ ‡å‡†ï¼šæ€»åˆ†â‰¥75åˆ†ä¸”POCä»£ç è´¨é‡â‰¥25åˆ†
ç»“æœï¼šé€šè¿‡/ä¸é€šè¿‡
"""
        
        validation_result = self.agent.run(validation_task)
        return self._parse_validation_result(validation_result)
    
    def _parse_validation_result(self, validation_result: str) -> Tuple[bool, List[str], int, str]:
        """
        è§£ææ ¡éªŒç»“æœ
        
        Returns:
            Tuple[bool, List[str], int, str]: (æ˜¯å¦é€šè¿‡, é—®é¢˜åˆ—è¡¨, è´¨é‡è¯„åˆ†, è¡Œä¸ºæŒ‡å¯¼)
        """
        # æå–æ€»åˆ†
        score_match = re.search(r'æ€»åˆ†ï¼š(\d+)/100åˆ†', validation_result)
        total_score = int(score_match.group(1)) if score_match else 0
        
        # æå–é—®é¢˜åˆ—è¡¨
        problems = []
        problem_section = re.search(r'### å­˜åœ¨é—®é¢˜\s*\n(.*?)### æ”¹è¿›å»ºè®®', validation_result, re.DOTALL)
        if problem_section:
            problem_lines = problem_section.group(1).strip().split('\n')
            for line in problem_lines:
                line = line.strip()
                if line and (line.startswith('1.') or line.startswith('2.') or line.startswith('3.') or 
                           line.startswith('4.') or line.startswith('5.') or line.startswith('-')):
                    problems.append(line)
        
        # æå–è¡Œä¸ºæŒ‡å¯¼
        improvement_guidance = ""
        guidance_section = re.search(r'### ä¸‹ä¸€è½®æ‰§è¡ŒæŒ‡å¯¼\s*\n(.*?)### æ˜¯å¦é€šè¿‡', validation_result, re.DOTALL)
        if guidance_section:
            improvement_guidance = guidance_section.group(1).strip()
        
        # æå–æ˜¯å¦é€šè¿‡
        pass_match = re.search(r'ç»“æœï¼š(é€šè¿‡|ä¸é€šè¿‡)', validation_result)
        is_passed = pass_match.group(1) == 'é€šè¿‡' if pass_match else False
        
        return is_passed, problems, total_score, improvement_guidance


class QualityControlConfig:
    """è´¨é‡æ§åˆ¶é…ç½®"""
    
    def __init__(self):
        self.max_retries = 2  # æ¯ä¸ªé˜¶æ®µæœ€å¤§é‡è¯•æ¬¡æ•°
        self.min_score_threshold = 75  # æœ€ä½åˆ†æ•°è¦æ±‚
        self.enable_validation = True  # æ˜¯å¦å¯ç”¨æ ¡éªŒ
        self.validation_timeout = 300  # æ ¡éªŒè¶…æ—¶æ—¶é—´(ç§’)
    
    def set_max_retries(self, retries: int):
        """è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°"""
        self.max_retries = max(0, retries)
        return self
    
    def set_score_threshold(self, threshold: int):
        """è®¾ç½®åˆ†æ•°é˜ˆå€¼"""
        self.min_score_threshold = max(0, min(100, threshold))
        return self
    
    def disable_validation(self):
        """ç¦ç”¨æ ¡éªŒ"""
        self.enable_validation = False
        return self
