"""
漏洞利用分析器 - 第三阶段
负责分析漏洞的利用方法、环境搭建和防护绕过技术
"""

import os
from smolagents import (
    CodeAgent,
    GitHubTools,
    WebTools,
)


class VulnerabilityExploiter:
    """漏洞利用分析器"""
    
    def __init__(self, model, max_steps=30):
        self.model = model
        self.max_steps = max_steps
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """创建专门用于漏洞利用分析的agent"""
        
        web_tools = WebTools(model=self.model, text_limit=100000, search_engine="duckduckgo")
        
        # 尝试添加GitHub工具
        try:
            github_token = os.getenv("GITHUB_TOKEN")
            if github_token:
                github_tools = GitHubTools(github_token)
                print(f"✅ 已添加 {len(github_tools.tools)} 个GitHub工具")
        except Exception as e:
            print(f"⚠️ GitHub工具初始化失败: {e}")
        
        agent = CodeAgent(
            model=self.model,
            tools=web_tools.tools+github_tools.tools,
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=2,
            planning_interval=8,
            name="vulnerability_exploiter",
            description="""漏洞利用专家，了解各种漏洞的利用方法，包括但不限于内核漏洞、应用中间件漏洞、web漏洞、云原生漏洞等等，可根据提供的漏洞信息分析出利用方法。
            
            能力包括但不限于：
            1. 漏洞环境的搭建配置
            2. 概念验证代码（POC）的开发
            3. 详细的复现步骤指导
            """,
        )

        return agent
    
    def run(self, task):
        """执行漏洞利用分析任务"""
        print(f"⚔️ 开始分析漏洞利用方法...")
        
        enhanced_task = f"""
{task}

---

注意事项：
1. 如果网络上存在漏洞利用POC，则分析其实现是否正确，如正确则采用
2. 通过互联网搜索受影响组件的使用方法，构造真实准确的漏洞复现环境，确保漏洞能够被触发
3. 构造漏洞利用POC，在漏洞环境复现中实现对漏洞的利用
4. 给出参考链接

请按照以下markdown结构输出利用分析结果：

## 漏洞复现
描述复现漏洞的思路
### 复现环境
详细列出搭建复现环境的步骤，并输出dockerfile
### 验证POC
根据漏洞原理及复现环境，输出漏洞利用POC，能够在复现环境上成功完成对漏洞的利用
### 参考链接
给出获得上述事实的参考链接
1. 
2. 
...
n. 

"""
        
        result = self.agent.run(enhanced_task)
        return result
