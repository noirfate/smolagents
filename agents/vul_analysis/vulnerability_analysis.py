"""
æ¼æ´åŸå› åˆ†æå™¨ - ç¬¬äºŒé˜¶æ®µ
è´Ÿè´£æ·±å…¥åˆ†ææ¼æ´çš„æŠ€æœ¯åŸç†ã€ä»£ç å±‚é¢çš„é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ
"""

import os
from smolagents import (
    MemoryCompressedCodeAgent,
    ListDirectoryTool,
    ReadFileTool,
    WriteFileTool,
    EditFileTool,
    FileSearchTool,
    FileContentSearchTool,
    ShellTools,
)
from smolagents.web_tools import WebTools

class VulnerabilityAnalyzer:
    """æ¼æ´åŸå› åˆ†æå™¨"""
    
    def __init__(self, model, max_steps=30, search_engine="duckduckgo", output_dir="output"):
        self.model = model
        self.max_steps = max_steps
        self.search_engine = search_engine
        self.output_dir = output_dir
        self.repo_dir = os.path.join(output_dir, "repo")
        self.agent = self._create_agent()
    
    def _create_agent(self):
        """åˆ›å»ºä¸“é—¨ç”¨äºæ¼æ´æŠ€æœ¯åˆ†æçš„agent"""
        
        # ç¡®ä¿ä»“åº“ç›®å½•å­˜åœ¨
        os.makedirs(self.repo_dir, exist_ok=True)
        
        # åŸºç¡€å·¥å…·
        tools = []
        
        # Webå·¥å…· - ç”¨äºæœç´¢å’Œè®¿é—®ç½‘é¡µ
        web_tools = WebTools(model=self.model, text_limit=100000, search_engine=self.search_engine)
        tools.extend(web_tools.tools)
        
        # æ–‡ä»¶ç³»ç»Ÿå·¥å…· - ç”¨äºæµè§ˆå’Œåˆ†æä»£ç 
        filesystem_tools = [
            ListDirectoryTool(),      # åˆ—å‡ºç›®å½•å†…å®¹
            ReadFileTool(),           # è¯»å–æ–‡ä»¶
            WriteFileTool(),          # å†™å…¥æ–‡ä»¶
            EditFileTool(),           # ç¼–è¾‘æ–‡ä»¶
            FileSearchTool(),         # æœç´¢æ–‡ä»¶
            FileContentSearchTool(),  # æœç´¢æ–‡ä»¶å†…å®¹
        ]
        tools.extend(filesystem_tools)
        
        # Shellå·¥å…· - ç”¨äºæ‰§è¡Œgitå‘½ä»¤å’Œå…¶ä»–ç³»ç»Ÿå‘½ä»¤
        shell_tools = ShellTools(
            default_page_size=20480,    # 20KBåˆ†é¡µå¤§å°ï¼Œè¶…è¿‡æ­¤å¤§å°è‡ªåŠ¨åˆ†é¡µ
            include_system_info=True    # åŒ…å«ç³»ç»Ÿä¿¡æ¯å·¥å…·
        )
        tools.extend(shell_tools.tools)
        
        agent = MemoryCompressedCodeAgent(
            model=self.model,
            tools=tools,
            max_steps=self.max_steps,
            additional_authorized_imports=["*"],
            verbosity_level=2,
            planning_interval=6,
            name="vulnerability_analyzer",
            description=f"""æ¼æ´åˆ†æä¸“å®¶ï¼Œå…·å¤‡æ·±åšçš„å®‰å…¨æŠ€æœ¯åŠŸåº•ï¼Œèƒ½å¤Ÿç†è§£å¤æ‚çš„æŠ€æœ¯ç»†èŠ‚,ä¸“é—¨è´Ÿè´£æ¼æ´çš„æŠ€æœ¯åˆ†æ, èƒ½å¤Ÿæ·±å…¥åˆ†ææ¼æ´çš„æŠ€æœ¯åŸç†ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
            
            1. æ¼æ´çš„æ ¹æœ¬åŸå› å’Œè§¦å‘æœºåˆ¶
            2. ä»£ç å±‚é¢çš„ç¼ºé™·åˆ†æ
            3. æ”»å‡»å‘é‡å’Œåˆ©ç”¨æ¡ä»¶
            4. ç¼“è§£æªæ–½åˆ†æ
            5. ä¿®å¤ä»£ç åˆ†æ
            6. ç›¸å…³æ¼æ´çš„å¯¹æ¯”ç ”ç©¶
            
            å¯ç”¨å·¥å…·ï¼š
            - Webæœç´¢å’Œé¡µé¢è®¿é—®å·¥å…·ï¼ˆsearch_web, visit_pageç­‰ï¼‰
            - æ–‡ä»¶ç³»ç»Ÿå·¥å…·ï¼š
              * list_directory: åˆ—å‡ºç›®å½•å†…å®¹
              * read_file: è¯»å–æ–‡ä»¶å†…å®¹
              * write_file: å†™å…¥æ–‡ä»¶
              * edit_file: ç¼–è¾‘æ–‡ä»¶
              * file_search: æœç´¢æ–‡ä»¶
              * file_content_search: æœç´¢æ–‡ä»¶å†…å®¹
            - Shellå·¥å…·ï¼š
              * execute_command: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆåŒ…æ‹¬gitå‘½ä»¤ï¼‰
              * get_system_info: è·å–ç³»ç»Ÿä¿¡æ¯
            
            å·¥ä½œç›®å½•ï¼š{self.repo_dir}
            """,
        )
        
        return agent
    
    def run(self, task):
        """æ‰§è¡Œæ¼æ´æŠ€æœ¯åˆ†æä»»åŠ¡"""
        print(f"ğŸ”¬ å¼€å§‹åˆ†ææ¼æ´æŠ€æœ¯åŸç†...")
        
        enhanced_task = f"""
{task}

---

æ·±åº¦åˆ†æè¦æ±‚ï¼š
1. **æºç çº§åˆ†æ**ï¼š
   - é¦–å…ˆä»NVDã€å®˜æ–¹å…¬å‘Šç­‰å¤„æŸ¥æ‰¾æ¼æ´ç›¸å…³çš„GitHubä»“åº“å’Œcommitä¿¡æ¯
   - å°è¯•ä½¿ç”¨`visit_page`é€šè¿‡urlè®¿é—®githubæºç æ—¶ï¼Œè¦ä½¿ç”¨rawé“¾æ¥ï¼Œä¾‹å¦‚ï¼šè¦è®¿é—®`https://github.com/containerd/containerd/blob/v2.1.0/pkg/archive/tar.go`ï¼Œå®é™…åº”è¯¥è®¿é—®`https://raw.githubusercontent.com/containerd/containerd/v2.1.0/pkg/archive/tar.go`
   - å¦‚æœä»ç½‘ä¸Šæ‰¾ä¸åˆ°ç¡®å®šçš„ä¿®å¤commitï¼Œè‹¥è¯¥ä»£ç ä»“æ”¯æŒgitï¼Œåˆ™å¯ä½¿ç”¨`git clone`ä¸‹è½½åˆ°{self.repo_dir}ç›®å½•ä¸‹ï¼Œè¿›è¡Œæœ¬åœ°åˆ†æ
   - åœ¨è¿›è¡Œæœ¬åœ°åˆ†ææ—¶ï¼Œå¯ä½¿ç”¨gitå‘½ä»¤åˆ†æcommitå†å²ï¼Œæ‰¾å‡ºæ¼æ´ç›¸å…³çš„ä¿®å¤è¡¥ä¸ï¼Œå¹¶ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·è¯»å–æºç æ–‡ä»¶ï¼Œè¿›è¡Œè¯¦ç»†åˆ†æ
     - **é‡è¦**ï¼šå¯¹äºgit diffç­‰å¯èƒ½äº§ç”Ÿé•¿è¾“å‡ºçš„å‘½ä»¤ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é¡µç®¡ç†ï¼š
       * ä½¿ç”¨`exec_cmd(command="git diff xxx", command_id="diff_main")`æ‰§è¡Œå‘½ä»¤å¹¶åˆ†é…å‘½ä»¤IDï¼Œä¸åŒçš„å‘½ä»¤ä½¿ç”¨ä¸åŒçš„IDï¼Œæˆ–è€…è®©ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ID
       * è¾“å‡ºè¶…è¿‡20KBæ—¶ä¼šè‡ªåŠ¨åˆ†é¡µæ˜¾ç¤ºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æµè§ˆï¼š
         - `cmd_page_down`å’Œ`cmd_page_up`ï¼šé€é¡µç¿»é¡µæŸ¥çœ‹
         - `get_cmd_page(command_id="diff_main", page_number=3)`ï¼šç›´æ¥è·³è½¬åˆ°æŒ‡å®šé¡µé¢
       * ä½¿ç”¨`list_commands`æŸ¥çœ‹æ‰€æœ‰ä¿å­˜çš„å‘½ä»¤è¾“å‡º
       * ä½¿ç”¨`get_cmd_output(command_id="diff_main")`é‡æ–°æŸ¥çœ‹æŒ‡å®šå‘½ä»¤çš„è¾“å‡º
       * å¯ä»¥é€šè¿‡`page_size`å‚æ•°è‡ªå®šä¹‰åˆ†é¡µå¤§å°ï¼Œå¦‚`exec_cmd(command="git log", page_size=10240)`è®¾ç½®ä¸º10KBåˆ†é¡µ
     * **å‘½ä»¤æœç´¢åŠŸèƒ½**ï¼š
       - ä½¿ç”¨`search_cmd(command_id="diff_main", keyword="vulnerability")`åœ¨æŒ‡å®šå‘½ä»¤è¾“å‡ºä¸­æœç´¢å…³é”®è¯
       - ä½¿ç”¨`search_all_cmds(keyword="CVE-2024")`åœ¨æ‰€æœ‰å‘½ä»¤è¾“å‡ºä¸­æœç´¢å…³é”®è¯
       - æœç´¢ç»“æœä¼šæ˜¾ç¤ºåŒ¹é…è¡ŒåŠå…¶ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤æ˜¾ç¤º1000è¡Œä¸Šä¸‹æ–‡
       - å¯ä»¥é€šè¿‡`context_lines`å‚æ•°è°ƒæ•´ä¸Šä¸‹æ–‡è¡Œæ•°
   - åŸºäºçœŸå®çš„æ¼æ´ä»£ç å’Œä¿®å¤è¡¥ä¸è¿›è¡ŒåŸç†åˆ†æ
   - å®Œæ•´è¾“å‡ºå…³é”®ä»£ç ç‰‡æ®µï¼Œä¸è¦çœç•¥æˆ–æ€»ç»“
   - è¯¦ç»†è§£é‡Šæ¯è¡Œä»£ç çš„ä½œç”¨å’Œé—®é¢˜æ‰€åœ¨
   
2. **æŠ€æœ¯ç»†èŠ‚æ·±æŒ–**ï¼š
   - æ·±å…¥åˆ†ææ•°æ®æµã€æ§åˆ¶æµå’Œæ—¶åºå…³ç³»
   - å…³æ³¨è¾¹ç•Œæ¡ä»¶ã€å¼‚å¸¸å¤„ç†ã€å¹¶å‘æ§åˆ¶ç­‰ç»†èŠ‚
   - åˆ†ææ¼æ´åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡¨ç°å·®å¼‚
   
3. **ä¿®å¤æ–¹æ¡ˆéªŒè¯**ï¼š
   - å¯¹æ¯”ä¿®å¤å‰åçš„ä»£ç å·®å¼‚
   - åˆ†æä¿®å¤æ–¹æ¡ˆçš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§
   - è€ƒè™‘æ˜¯å¦å­˜åœ¨ç»•è¿‡ä¿®å¤çš„å¯èƒ½æ€§
   
4. **å®é™…åˆ©ç”¨åœºæ™¯**ï¼š
   - åˆ†æçœŸå®æ”»å‡»åœºæ™¯ä¸­çš„åˆ©ç”¨æ¡ä»¶
   - è€ƒè™‘ä¸åŒç¯å¢ƒä¸‹çš„åˆ©ç”¨éš¾åº¦å’Œå½±å“
   - å…³æ³¨ä¸å…¶ä»–å®‰å…¨æœºåˆ¶çš„äº¤äº’

æ³¨æ„äº‹é¡¹ï¼š
- é¦–å…ˆå°è¯•ä»NVDã€å®˜æ–¹å…¬å‘Šç­‰å¤„æŸ¥æ‰¾æ¼æ´ç›¸å…³çš„GitHubä»“åº“ä¿¡æ¯
- ä»£ç ä»“åº“ç®¡ç†ç­–ç•¥ï¼š
  * å¦‚æœ{self.repo_dir}ç›®å½•ä¸‹å·²å­˜åœ¨å¯¹åº”ä»“åº“ï¼Œä½¿ç”¨`git pull`æ›´æ–°åˆ°æœ€æ–°ä»£ç 
  * å¦‚æœä»“åº“ä¸å­˜åœ¨ï¼Œä½¿ç”¨`git clone`ä¸‹è½½ä»“åº“åˆ°{self.repo_dir}/[repo_name]
  * å¤šä¸ªä»“åº“å¯ä»¥å¹¶å­˜åœ¨{self.repo_dir}ç›®å½•ä¸‹
- Gitæ“ä½œç¤ºä¾‹ï¼š
  * æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨ï¼šä½¿ç”¨`list_directory`å·¥å…·æŸ¥çœ‹{self.repo_dir}ç›®å½•å†…å®¹
  * å…‹éš†æ–°ä»“åº“ï¼š`git clone https://github.com/user/repo.git {self.repo_dir}/repo_name`
  * æ›´æ–°å·²æœ‰ä»“åº“ï¼š`git -C {self.repo_dir}/repo_name pull`
  * æŸ¥çœ‹æäº¤å†å²ï¼š`git -C {self.repo_dir}/repo_name log --oneline --grep="CVE-XXXX"`
  * æŸ¥çœ‹å…·ä½“æäº¤ï¼š`git -C {self.repo_dir}/repo_name show <commit_hash>`
  * å¯¹æ¯”ä»£ç å·®å¼‚ï¼š`git -C {self.repo_dir}/repo_name diff <commit1>..<commit2> -- path/to/file`
- ä½¿ç”¨read_fileå·¥å…·è¯»å–å…·ä½“çš„æºç æ–‡ä»¶è¿›è¡Œåˆ†æ
- ä½¿ç”¨list_directoryå·¥å…·æµè§ˆç›®å½•ç»“æ„
- ä½¿ç”¨file_searchå’Œfile_content_searchå·¥å…·æœç´¢ç›¸å…³æ–‡ä»¶
- å·¥ä½œç›®å½•ï¼š{self.repo_dir}
- ç”Ÿæˆçš„åˆ†æç»“æœè¦ä½¿ç”¨`final_answer`å·¥å…·å®Œæ•´è¾“å‡º

è¯·æŒ‰ç…§ä»¥ä¸‹markdownç»“æ„è¾“å‡ºæŠ€æœ¯åˆ†æç»“æœï¼š

## æ¼æ´åˆ†æ
æ ¹æ®æœé›†åˆ°çš„ä¿¡æ¯ï¼Œæ€»ç»“æ¼æ´çš„æˆå› åŠæŠ€æœ¯åŸç†

### æŠ€æœ¯åŸç†
#### æ·±åº¦æºç åˆ†æ
åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹åˆ†æè¦ç‚¹ï¼š
- å®Œæ•´å±•ç¤ºæ¼æ´ç›¸å…³çš„æºä»£ç ï¼ˆä¸è¦çœç•¥ï¼‰
- é€è¡Œåˆ†æä»£ç é€»è¾‘å’Œé—®é¢˜æ‰€åœ¨
- è¯¦ç»†è¯´æ˜æ¼æ´è§¦å‘çš„æ¡ä»¶å’Œæ—¶æœº
- åˆ†ææ•°æ®æµå’Œæ§åˆ¶æµçš„å¼‚å¸¸è·¯å¾„

#### ä¿®å¤ä»£ç åˆ†æ
åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹åˆ†æè¦ç‚¹ï¼š
- è¡¥ä¸ä»£ç çš„commit id
- å±•ç¤ºå®Œæ•´çš„ä¿®å¤è¡¥ä¸ä»£ç 
- å¯¹æ¯”ä¿®å¤å‰åçš„å…³é”®å·®å¼‚
- åˆ†æä¿®å¤æ–¹æ¡ˆçš„æŠ€æœ¯åŸç†
- è¯„ä¼°ä¿®å¤çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§

### æ¼æ´è§¦å‘æœºåˆ¶
è¯¦ç»†åˆ†ææ¼æ´çš„è§¦å‘æ¡ä»¶ã€æ—¶åºè¦æ±‚å’Œç¯å¢ƒä¾èµ–ï¼š
- å…·ä½“çš„è§¦å‘æ­¥éª¤å’Œæ“ä½œåºåˆ—
- å…³é”®çš„æ—¶é—´çª—å£å’Œç«äº‰æ¡ä»¶
- ç¯å¢ƒé…ç½®å’Œç³»ç»ŸçŠ¶æ€è¦æ±‚

### æ’æŸ¥æŒ‡å¯¼
æ ¹æ®æ¼æ´äº§ç”Ÿçš„åŸç†ï¼Œç»™å‡ºæ’æŸ¥æŒ‡å¯¼ï¼Œè¦åˆ—å‡ºå…·ä½“çš„æ’æŸ¥æ­¥éª¤ï¼Œéœ€è¦åŒ…å«å¤šç§æ’æŸ¥æ–¹æ³•ï¼Œå¦‚ï¼š
1. æ ¹æ®æ¼æ´ç»„ä»¶ç‰ˆæœ¬è¿›è¡Œæ’æŸ¥
2. æ ¹æ®è§¦å‘æ¼æ´çš„ç°è±¡è¿›è¡Œæ’æŸ¥ï¼Œæ„é€ ç®€å•çš„æ£€æµ‹è„šæœ¬

### ç¼“è§£æªæ–½
æ ¹æ®æ¼æ´çš„æˆå› åŠæŠ€æœ¯åŸç†ï¼Œç»™å‡ºç¼“è§£æªæ–½ï¼Œéœ€è¦åˆ—å‡ºå…·ä½“çš„ç¼“è§£æªæ–½æ‰§è¡Œæ­¥éª¤

### å‚è€ƒé“¾æ¥
ç»™å‡ºè·å¾—ä¸Šè¿°äº‹å®çš„å‚è€ƒé“¾æ¥ï¼Œç‰¹åˆ«æ˜¯æºç å’Œè¡¥ä¸é“¾æ¥
1. 
2. 
...
n. 

"""
        
        result = self.agent.run(enhanced_task)
        return result
    
    def get_repo_dir(self):
        """è·å–ä»“åº“ç›®å½•è·¯å¾„"""
        return self.repo_dir
    
    def list_repos(self):
        """åˆ—å‡ºå·²ä¸‹è½½çš„ä»“åº“"""
        if os.path.exists(self.repo_dir):
            repos = [d for d in os.listdir(self.repo_dir) 
                    if os.path.isdir(os.path.join(self.repo_dir, d))]
            return repos
        return []
